# SP Manager - Agent Instructions

## Project Overview

**SP Manager** is a Next.js application for managing and documenting SQL Server Stored Procedures. It uses MongoDB for metadata storage and supports OpenAI integration for automatic documentation generation.

## Technology Stack

- **Frontend**: Next.js 16, React 19, TypeScript, TailwindCSS 4, shadcn/ui
- **Backend**: Next.js API Routes, Node.js
- **Databases**: SQL Server (source data), MongoDB (metadata & configuration)
- **AI**: OpenAI API (optional)
- **DevOps**: Docker, Docker Compose

## Architecture

The project follows **Clean Architecture** with layered structure:

```
src/
├── app/              # Next.js App Router (UI + API Routes)
├── domain/           # Entities and interfaces
├── application/      # Business logic services
├── infrastructure/   # Implementations (repositories, external services)
├── components/       # React components
├── context/          # React contexts
└── layout/           # Layout components
```

## Key Features

1. **Dynamic Configuration System**
   - SQL Server and OpenAI credentials stored in MongoDB
   - No need to restart Docker when changing configuration
   - Fallback to `.env` if no configuration exists
   - Configuration cache (1 minute TTL)

2. **Swagger API Documentation**
   - 19 endpoints documented in Spanish
   - Interactive testing via Swagger UI at `/api-docs`
   - OpenAPI 3.0 specification

3. **SP Documentation**
   - View, edit, and save SP descriptions
   - Project tagging system with autocomplete
   - AI-powered documentation generation
   - SQL code export to `.sql` files

4. **Navigation**
   - All navigation uses absolute URLs (`/`) to ensure consistency
   - Sidebar, header, and list components navigate to root page

## Important Files & Patterns

### Configuration System

- **Domain**: `src/domain/models/Config.ts`
- **Schema**: `src/infrastructure/database/schemas/ConfigSchema.ts`
- **Repository**: `src/infrastructure/repositories/ConfigRepository.ts`
- **Service**: `src/application/services/ConfigService.ts`
- **SQL Connection**: `src/infrastructure/sqlConnection.ts` (uses dynamic config)
- **OpenAI Service**: `src/infrastructure/services/OpenAIService.ts` (accepts apiKey and model)

### API Endpoints

All API routes are in `src/app/api/`:
- `config/` - Configuration management
- `databases/` - List databases
- `sps/` - List stored procedures
- `sp-detail/` - SP details and updates
- `projects/` - Project management
- `scan/` - Database scanning
- `backup/` - Export functionality
- `statistics/` - System statistics
- `doc/` - OpenAPI specification

### Frontend Components

- **SPDetail**: `src/components/sp/SPDetail.tsx` - Main SP detail view with tabs
- **SPList**: `src/components/sp/SPList.tsx` - List of SPs for a database
- **ProjectsView**: `src/components/projects/ProjectsView.tsx` - Search SPs by project
- **DatabaseConfig**: `src/components/DatabaseConfig.tsx` - Database configuration UI
- **OpenAIConfig**: `src/components/OpenAIConfig.tsx` - OpenAI configuration UI

### Layout Components

- **AppSidebar**: `src/layout/AppSidebar.tsx` - Sidebar with database selector and SP list
- **AppHeader**: `src/layout/AppHeader.tsx` - Header with database dropdown and sync button

## Common Tasks

### Adding a New API Endpoint

1. Create route file in `src/app/api/[endpoint]/route.ts`
2. Add JSDoc comments for Swagger documentation:
   ```typescript
   /**
    * @swagger
    * /api/endpoint:
    *   get:
    *     tags:
    *       - Category
    *     summary: Brief description
    *     description: Detailed description
    *     responses:
    *       200:
    *         description: Success response
    */
   ```
3. Export `GET`, `POST`, `PUT`, or `DELETE` async functions
4. Use dependency injection from `src/application/di.ts`

### Adding a New Configuration Field

1. Update `Config.ts` domain model
2. Update `ConfigSchema.ts` Mongoose schema
3. Update `ConfigRepository.ts` if needed
4. Update `ConfigService.ts` to handle new field
5. Update frontend component (`DatabaseConfig.tsx` or `OpenAIConfig.tsx`)
6. Update API routes in `src/app/api/config/`

### Fixing Navigation Issues

All navigation should use **absolute URLs** starting with `/`:
- ✅ `router.push(\`/?db=${db}&sp=${sp}\`)`
- ❌ `router.push(\`?db=${db}&sp=${sp}\`)` (relative, breaks from non-root pages)

Check these files for navigation:
- `src/layout/AppSidebar.tsx` - SP links
- `src/layout/AppHeader.tsx` - Database selector
- `src/components/sp/SPList.tsx` - SP list clicks
- `src/components/projects/ProjectsView.tsx` - Project SP cards

### Working with SQL Server

- Connection is managed in `src/infrastructure/sqlConnection.ts`
- Uses connection pooling with `mssql` library
- Configuration is fetched from `ConfigService` with fallback to `.env`
- Use `refreshSqlConnection()` to update connection without restart

### Working with MongoDB

- Connection is managed in `src/infrastructure/dbConnect.ts`
- Uses Mongoose for ODM
- Schemas are in `src/infrastructure/database/schemas/`
- Repositories are in `src/infrastructure/repositories/`

## Environment Variables

Required in `.env`:

```env
# SQL Server (Fallback)
SQL_HOST=server-address
SQL_USER=username
SQL_PASSWORD=password
SQL_DATABASE=master
SQL_PORT=1433

# MongoDB
MONGODB_URI=mongodb://localhost:27017/sp-manager

# OpenAI (Optional)
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini
```

## Development Commands

```bash
npm run dev          # Start development server
npm run build        # Build for production
npm start            # Start production server
npm run lint         # Run ESLint
```

## Docker Commands

```bash
docker-compose up -d       # Start containers
docker-compose down        # Stop containers
docker-compose logs -f     # View logs
```

## Testing

- Manual testing via Swagger UI at `/api-docs`
- Test database connections via Configuration page
- Test OpenAI integration via SP detail "Analizar con IA" button

## Known Issues & Solutions

### TypeScript Lint Errors

The IDE may show lint errors for missing type definitions. These are expected during development and don't affect runtime:
- `Cannot find module 'react'` - Types are installed, IDE issue
- `JSX element implicitly has type 'any'` - IDE issue, works at runtime

### Navigation Not Working

If navigation doesn't update the page:
1. Check if using absolute URLs (`/` prefix)
2. Verify `router.push()` is from `next/navigation`
3. Check browser console for errors

### Configuration Not Persisting

If configuration doesn't save:
1. Check MongoDB connection
2. Verify `ConfigService` is being used
3. Check API endpoint responses in Network tab
4. Ensure `refreshSqlConnection()` is called after saving DB config

## Best Practices

1. **Always use TypeScript** - No `any` types unless absolutely necessary
2. **Follow Clean Architecture** - Keep layers separated
3. **Document API endpoints** - Use JSDoc for Swagger
4. **Use absolute URLs** - For all navigation
5. **Test connections** - Before saving configuration
6. **Handle errors gracefully** - Show user-friendly messages
7. **Use dependency injection** - Import from `di.ts`
8. **Keep components focused** - Single responsibility principle

## Deployment

1. Build the application: `npm run build`
2. Set environment variables in production
3. Run with Docker Compose or deploy to cloud platform
4. Ensure MongoDB and SQL Server are accessible
5. Configure firewall rules for database access

## Support

For questions or issues:
1. Check this `.agent` file first
2. Review `README.md` for user documentation
3. Check `walkthrough.md` in artifacts for implementation details
4. Review API documentation at `/api-docs`

---

**Last Updated**: 2026-01-28
**Version**: 1.0.0
**Maintained by**: Steven Rodríguez
